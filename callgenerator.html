<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Service Call Generator</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; color:#666666; }
    h1 { color:#00B1E2; }
    label { display:block; margin-top:15px; font-weight:bold; color:#00B1E2; }
    input, textarea, select {
      width:100%;
      padding:10px;
      margin-top:5px;
      border:1px solid #ccc;
      border-radius:5px;
      background:#fff;
      color:#3D434C;
      transition: box-shadow 0.2s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline:none;
      box-shadow:0 0 6px #00B1E2;
      border-color:#00B1E2;
    }
    button { margin-top:15px; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
    #generateBtn { background:#00B1E2; color:white; }
    #downloadBtn { background:#3D434C; color:white; display:none; }
    #playBtn { background:#666666; color:white; display:none; }
    #stopBtn { background:#999999; color:white; display:none; }
    #genScriptBtn { background:#00B1E2; color:white; }
    #status { margin-top:15px; font-style:italic; display:flex; align-items:center; gap:8px; color:#00B1E2; }
    .spinner {
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid #ccc;
      border-top:2px solid #00B1E2;
      border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Service Call Generator</h1>

  <label>Enter your OpenAI API Key:</label>
  <input type="password" id="apiKey" placeholder="sk-...">

  <label>Select Output Language:</label>
  <select id="language">
    <option value="English">English</option>
    <option value="German">German</option>
    <option value="Dutch">Dutch</option>
    <option value="French">French</option>
    <option value="Spanish">Spanish</option>
    <option value="Polish">Polish</option>
    <option value="Japanese">Japanese</option>
    <option value="Cantonese">Cantonese</option>
  </select>

  <label>Enter your script:</label>
  <textarea id="scriptInput" rows="12" placeholder="Type or paste the conversation script here..."></textarea>

  <button id="genScriptBtn">‚úçÔ∏è Auto Generate Script</button>
  <button id="generateBtn">üéôÔ∏è Generate Audio</button>
  <button id="playBtn">‚ñ∂Ô∏è Play Audio</button>
  <button id="stopBtn">‚èπÔ∏è Stop Audio</button>
  <button id="downloadBtn">‚¨áÔ∏è Download WAV</button>

  <div id="status"></div>

  <script>
    let audioBlob = null;
    let audioUrl = null;
    let audioElement = null;

    // Load stored API key on page load
    window.addEventListener("DOMContentLoaded", () => {
      const storedKey = localStorage.getItem("openai_api_key");
      if (storedKey) {
        document.getElementById("apiKey").value = storedKey;
      }
    });

    // Save API key when user types
    document.getElementById("apiKey").addEventListener("input", (e) => {
      localStorage.setItem("openai_api_key", e.target.value.trim());
    });

    // Function to auto-generate script
    document.getElementById("genScriptBtn").addEventListener("click", async () => {
      const apiKey = document.getElementById("apiKey").value.trim();
      const language = document.getElementById("language").value;
      const statusEl = document.getElementById("status");

      if (!apiKey) {
        alert("Please enter your API key.");
        return;
      }

      statusEl.innerHTML = '<span class="spinner"></span> Generating script... please wait';

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
              {
                role: "system",
                content: "You are a script writer. Only output the raw dialogue lines, no scene descriptions, no extra formatting, no titles, and do not label speakers with names like Speaker A or Speaker B. Alternate lines implicitly indicate turn-taking."
              },
              {
                role: "user",
                content: `Write a detailed script for a customer service interaction over the phone. The setting is an e-commerce company, and the customer has called about an order. The script should capture a realistic conversation, including the agent's tone and the customer's emotional state. The AI has full creative license to determine the customer's specific problem, the agent's competency, and the final resolution. The script can portray a positive, negative, or mixed outcome. Generate the script in ${language}.`
              }
            ]
          })
        });

        if (!response.ok) {
          throw new Error("ChatGPT API request failed: " + response.status + " " + response.statusText);
        }

        const data = await response.json();
        const script = data.choices[0].message.content;
        document.getElementById("scriptInput").value = script;
        statusEl.innerText = "‚úÖ Script generated successfully!";
      } catch (err) {
        console.error(err);
        statusEl.innerText = "‚ùå Error: " + err.message;
      }
    });

    // Function to generate audio with two voices alternating per line
    document.getElementById("generateBtn").addEventListener("click", async () => {
      const apiKey = document.getElementById("apiKey").value.trim();
      const script = document.getElementById("scriptInput").value.trim();
      const statusEl = document.getElementById("status");
      const downloadBtn = document.getElementById("downloadBtn");
      const playBtn = document.getElementById("playBtn");
      const stopBtn = document.getElementById("stopBtn");

      if (!apiKey || !script) {
        alert("Please enter both your API key and a script.");
        return;
      }

      statusEl.innerHTML = '<span class="spinner"></span> Generating audio... please wait';
      downloadBtn.style.display = "none";
      playBtn.style.display = "none";
      stopBtn.style.display = "none";

      try {
        const lines = script.split(/\n/).filter(line => line.trim() !== "");
        let combinedAudio = new Blob([], { type: "audio/wav" });

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const voice = i % 2 === 0 ? "alloy" : "verse"; // alternate voices by line
          const response = await fetch("https://api.openai.com/v1/audio/speech", {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + apiKey,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "gpt-4o-mini-tts",
              voice: voice,
              input: line,
              format: "wav"
            })
          });

          if (!response.ok) {
            throw new Error("API request failed: " + response.status + " " + response.statusText);
          }

          const arrayBuffer = await response.arrayBuffer();
          const chunk = new Blob([arrayBuffer], { type: "audio/wav" });
          combinedAudio = new Blob([combinedAudio, chunk], { type: "audio/wav" });
        }

        audioBlob = combinedAudio;
        audioUrl = URL.createObjectURL(audioBlob);
        audioElement = new Audio(audioUrl);

        statusEl.innerHTML = "‚úÖ Audio generated successfully!";
        downloadBtn.style.display = "inline-block";
        playBtn.style.display = "inline-block";
        stopBtn.style.display = "inline-block";
      } catch (err) {
        console.error(err);
        statusEl.innerText = "‚ùå Error: " + err.message;
      }
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (!audioBlob) return;
      const a = document.createElement("a");
      a.href = audioUrl;
      a.download = "AI-Servicecall.wav";
      a.click();
    });

    document.getElementById("playBtn").addEventListener("click", () => {
      if (audioElement) {
        audioElement.play();
      }
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      if (audioElement) {
        audioElement.pause();
        audioElement.currentTime = 0;
      }
    });
  </script>
</body>
</html>
