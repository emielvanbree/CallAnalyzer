<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Service Call Analyzer</title>
    <style>
        /* * --------------------
         * COLOR SCHEME
         * --------------------
         */
        :root {
            /* Light Mode - Base colors are greys */
            --primary: #111827; /* Almost Black */
            --accent: #00B1E2; /* Light Blue */
            --medium-grey: #666666;
            --just-grey: #3D434C;
            
            --surface: #FFFFFF;
            --surface-alt: #F3F2F1; /* Subtle, soft background */
            
            --radius: 8px; /* Softer, modern corner radius */
            --gap: 20px;
            --shadow: 0 4px 8px rgba(0,0,0,0.06);
        }

        /* Dark Mode variables */
        body[data-theme='dark'] {
            --primary: #D1D5DB; /* Soft off-white */
            --secondary: #9CA3AF; /* Medium grey for secondary text */
            --accent: #00B1E2; /* Light Blue */
            
            --surface: #282C34; /* Muted dark grey surface */
            --surface-alt: #2F343A; /* Slightly different dark background */
            
            --table-background-dark: #4C515B; /* New medium grey for table background */
            --table-text-dark: #ABB2BF; /* Soft contrasting text color for table */
            --card-border-dark: #4B5563; /* Subtle border for dark cards */
        }

        /* System preference-based dark mode (initial load) */
        @media (prefers-color-scheme: dark) {
            body:not([data-theme='light']) {
                --primary: #D1D5DB;
                --secondary: #9CA3AF;
                --accent: #00B1E2;
                
                --surface: #282C34;
                --surface-alt: #2F343A;
                
                --table-background-dark: #4C515B;
                --table-text-dark: #ABB2BF;
                --card-border-dark: #4B5563;
            }
        }

        /*
         * --------------------
         * TYPOGRAPHY
         * --------------------
         */
        body {
            font-family: 'Segoe UI', Calibri, 'Century Gothic', Arial, sans-serif;
            color: var(--primary);
            margin: 0;
            background: var(--surface-alt);
            line-height: 1.5;
            font-size: 16px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .wrap {
            max-width: 1024px;
            margin: 0 auto;
            padding: clamp(24px, 6vw, 48px);
        }

        h1, h2, h3, h4 {
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600; /* Semibold for a modern touch */
            color: var(--primary);
            line-height: 1.2;
            transition: color 0.3s ease;
        }

        h1 {
            font-size: clamp(34px, 8vw, 60px);
            margin: 0 0 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--accent);
        }
        
        h1 img {
            height: 60px; /* Adjust height as needed */
            margin-right: 10px;
        }
        
        .subtitle {
            font-style: normal; /* No italics for a cleaner look */
            color: var(--secondary);
            font-size: clamp(18px, 3.5vw, 24px);
            margin: 0 0 30px;
        }

        h3 {
            font-size: clamp(22px, 4vw, 30px);
            margin: 0 0 16px;
            color: var(--primary);
        }

        /*
         * --------------------
         * UI COMPONENTS
         * --------------------
         */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: clamp(24px, 5vw, 40px);
            border: 1px solid #E5E5E5;
            margin-bottom: var(--gap);
            transition: box-shadow 0.2s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
        }
        body[data-theme='dark'] .card, @media (prefers-color-scheme: dark) { body:not([data-theme='light']) .card { border-color: var(--card-border-dark); } }


        .controls,
        .panel,
        .api-key-controls {
            display: grid;
            gap: var(--gap);
        }

        .controls {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            position: sticky;
            top: 0;
            background: var(--surface-alt);
            padding: 10px 0;
            z-index: 5;
        }

        .api-key-controls {
            grid-template-columns: 1fr;
        }

        @media (min-width: 500px) {
            .api-key-controls {
                grid-template-columns: 1fr auto;
            }
        }

        .name-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap);
            margin-bottom: 20px;
        }
        @media (min-width: 600px) {
            .name-inputs {
                grid-template-columns: 1fr 1fr;
            }
        }

        input[type="password"],
        input[type="text"],
        textarea.input-area {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-grey);
            border-radius: var(--radius);
            box-sizing: border-box;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
            background: var(--surface);
            color: var(--primary);
        }
        
        input[type="password"]:focus,
        input[type="text"]:focus,
        textarea.input-area:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        textarea.input-area {
            min-height: 180px;
            resize: vertical;
        }

        button {
            width: 100%;
            border: none;
            border-radius: var(--radius);
            padding: 14px 16px;
            font-weight: 600;
            font-size: 16px;
            background: var(--accent);
            color: var(--surface);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out, opacity 0.3s ease;
            box-sizing: border-box;
            min-height: 52px;
        }
        
        button:hover {
            background: #00C6FF;
            transform: translateY(-2px);
        }

        button:active {
            background: #0093BE;
            transform: translateY(0);
        }

        button.secondary {
            background: var(--just-grey);
        }
        
        button.secondary:hover {
            background: var(--medium-grey);
        }

        button.secondary:active {
            background: #2E333A;
        }

        button:disabled {
            opacity: 0.4;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            background: var(--medium-grey);
        }

        .panel {
            margin-top: 14px;
        }

        .pre {
            background: var(--surface-alt);
            border: 1px solid #E5E5E5;
            border-radius: var(--radius);
            padding: clamp(16px, 3vw, 24px);
            min-height: 160px;
            font-size: 16px;
            line-height: 1.5;
            color: var(--primary);
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            overflow-x: hidden;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        body[data-theme='dark'] .pre, @media (prefers-color-scheme: dark) { body:not([data-theme='light']) .pre { border-color: var(--card-border-dark); } }
        
        /*
         * --------------------
         * SCORECARD & SUMMARY
         * --------------------
         */
        table.scorecard {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            table-layout: fixed;
        }

        table.scorecard th,
        table.scorecard td {
            border: 1px solid #E5E5E5;
            padding: 12px;
            vertical-align: top;
            word-break: break-word;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        table.scorecard th {
            background: var(--accent);
            color: var(--surface);
            font-weight: 600;
            text-align: left;
        }
        
        /* Light Mode alternating rows */
        table.scorecard tr:nth-child(odd) {
            background: var(--surface);
        }
        table.scorecard tr:nth-child(even) {
            background: #FAFAFA;
        }

        /* Dark Mode table - all rows same color, with softer text */
        body[data-theme='dark'] table.scorecard tr,
        @media (prefers-color-scheme: dark) {
          body:not([data-theme='light']) table.scorecard tr {
            background: var(--table-background-dark);
          }
        }
        
        /* Dark Mode text and borders for all cells */
        body[data-theme='dark'] table.scorecard th,
        body[data-theme='dark'] table.scorecard td,
        @media (prefers-color-scheme: dark) {
            body:not([data-theme='light']) table.scorecard th,
            body:not([data-theme='light']) table.scorecard td {
                border-color: var(--card-border-dark);
                color: var(--table-text-dark); /* Using the new, softer color variable */
            }
        }
        
        .overall-score {
            font-weight: 700;
            color: var(--accent);
            font-size: 22px;
            margin: 8px 0 6px;
        }
        
        .post-summary {
            margin-top: 24px;
        }
        
        .post-summary p {
            margin: 0 0 10px;
        }
        
        .post-summary ul {
            margin: 0;
            padding-left: 24px;
            list-style-type: 'üëâ';
        }
        
        .post-summary li {
            margin-bottom: 8px;
        }
        
        .actions-row {
            display: flex;
            justify-content: center; /* Centered the button */
            gap: 12px;
            margin-top: 24px;
        }

        .actions-row button {
            width: auto;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            background: #E8F8FE;
            color: var(--accent);
            font-weight: 600;
            font-size: 13px;
        }
        body[data-theme='dark'] .status, @media (prefers-color-scheme: dark) { body:not([data-theme='light']) .status { background: #3B3A39; } }

        .processing-indicator {
            margin-left: 8px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            margin-top: 40px;
            font-size: 14px;
            color: var(--secondary);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: color 0.3s ease;
        }

        /*
         * --------------------
         * POPUP & OVERLAY
         * --------------------
         */
        #privacyPopup, #audioPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Softer overlay */
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        #privacyPopup .content, #audioPopup .content {
            background: var(--surface);
            padding: clamp(24px, 5vw, 40px);
            border-radius: var(--radius);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        #audioPopup .content {
            text-align: center;
        }
        #audioPopup audio {
            width: 100%;
        }

        #privacyPopup h2 {
            margin-top: 0;
            color: var(--accent);
            text-align: center;
            font-size: 28px;
            transition: color 0.3s ease;
        }

        #privacyPopup button#closePopupBtn, #audioPopup button#closeAudioPopupBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: auto;
            min-width: 0;
            padding: 8px 16px;
            background: var(--just-grey);
            box-shadow: none;
        }

        /* Specific style for a disabled blue button */
        .button-blue-disabled {
            background: var(--medium-grey) !important;
            cursor: not-allowed !important;
            opacity: 0.4;
        }
        
        /* Dark mode transition styles */
        body[data-theme='dark'] .card, body[data-theme='dark'] .pre, 
        body[data-theme='dark'] table.scorecard th, body[data-theme='dark'] table.scorecard td, 
        body[data-theme='dark'] #privacyPopup .content, body[data-theme='dark'] #audioPopup .content, 
        body[data-theme='dark'] .status {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        body[data-theme='dark'] h1, body[data-theme='dark'] h2, body[data-theme='dark'] h3, body[data-theme='dark'] h4, body[data-theme='dark'] footer {
            transition: color 0.3s ease;
        }
    </style>
</head>
<body data-theme="light">
    <div class="wrap">
        <h1><img src="salesupplylogo.png" alt="Salesupply Logo" />Service Call Analyzer</h1>
        <p class="subtitle"></p>

        <div class="card">
            <h3>Enter your OpenAI API Key</h3>
            <p>Your key is stored only in your browser's local storage.</p>
            <div class="api-key-controls">
                <input type="password" id="apiKeyInput" placeholder="sk-..." />
                <button id="saveKeyBtn">Save Key</button>
            </div>
        </div>
        
        <div class="controls">
            <button id="selectFileBtn">Select Audio File</button>
            <button id="uploadBtn" disabled>Upload & Analyze</button>
            <button id="listenBtn" disabled class="secondary">Listen to Audio</button>
            <button id="clearBtn" class="secondary">Clear</button>
            <button id="darkModeToggle" class="secondary">Light Mode</button>
            <input id="audioFile" type="file" accept="audio/wav,audio/mpeg,audio/flac,.wav,.mp3,.flac" style="display:none" />
        </div>

        <div class="panel">
            <div class="card">
                <h3>Call Information</h3>
                <div class="name-inputs">
                    <input type="text" id="agentNameInput" placeholder="Name of service agent" />
                    <input type="text" id="customerNameInput" placeholder="Customer name" />
                </div>
                
                <h3>Transcript <span id="transcriptStatus" class="status">Idle</span></h3>
                <pre id="transcript" class="pre">No transcript yet...</pre>
            </div>

            <div class="card">
                <h3>Service Call Scorecard <span id="scoreStatus" class="status">Waiting</span></h3>
                <div id="summary" class="pre">No scorecard yet...</div>
                <div class="actions-row">
                    <button id="downloadWordBtn" class="secondary" disabled>Download as Word</button>
                </div>
            </div>
        </div>

        <footer>
            All call transcripts and scorecards are automatically anonymized in accordance with GDPR standards and regulations.
            <button id="privacyBtn" class="secondary">Privacy Statement</button>
        </footer>
    </div>

    <div id="privacyPopup">
        <div class="content">
            <h2>Privacy Statement</h2>
            <p>Your privacy is our priority. This website is designed to analyze service calls without collecting or storing any of your personal data. We want you to feel confident knowing how your information is handled.</p>
            <h4>How It Works: Privacy by Design</h4>
            <p>The "Service Call Analyzer" is a "frontend" web application. This means it runs entirely in your web browser. We do not have a separate server to process or store your data.</p>
            <ul>
                <li>**No Data Storage:** We do not save your audio recordings, uploaded files, or transcripts on our servers. Your information exists only temporarily in your browser's memory while the analysis is taking place.</li>
                <li>**Direct-to-API Communication:** Your data is sent directly from your browser to trusted third-party services for processing. We use **AssemblyAI** for transcription and **OpenAI** for generating the scorecard.</li>
                <li>**Data Minimization:** We only send the information that is necessary for the task at hand.</li>
            </ul>
            <h4>Our Privacy Safeguards</h4>
            <p>We've implemented a multi-layered approach to protect your data and comply with privacy regulations like the GDPR.</p>
            <ol>
                <li>**Client-Side Anonymization:** Before any transcript is sent to a third-party API, a special function in the application automatically checks for sensitive information like names, phone numbers, email addresses, and account details. It replaces this data with a generic placeholder like **[ANONYMIZED DATA]** to ensure no personally identifiable information (PII) leaves your browser in its original form.</li>
                <li>**Explicit AI Instructions:** We specifically instruct the AI model to perform an additional, strict check for any remaining PII and to replace it with a placeholder to ensure compliance.</li>
                <li>**Third-Party Agreements:** We have formal agreements, known as Data Processing Addendums (DPAs), with our service providers (AssemblyAI and OpenAI). These contracts legally bind them to handle your data securely and in accordance with privacy laws.</li>
                <li>**Your Responsibility:** Once you download the generated scorecard and transcript as a Word document, you are responsible for how you store and handle that file.</li>
            </ol>
            <p>For any questions about our privacy practices, please contact us.</p>
            <button id="closePopupBtn">Close</button>
        </div>
    </div>
        
    <div id="audioPopup">
        <div class="content">
            <h2>Listen to Audio File</h2>
            <audio id="audioPlayer" controls></audio>
            <button id="closeAudioPopupBtn" class="secondary">Close</button>
        </div>
    </div>

    <script>
        // ====== CONFIG (keys you provided) ======
        const ASSEMBLY_KEY = "99bfc1680f0b4cca9e7d3ce2495eb058";
        const OPENAI_MODEL = "gpt-4o-mini";
        
        let OPENAI_KEY = '';
        let audioBlob = null;
        let audioURL = null; 

        // ====== Elements ======
        const selectFileBtn = document.getElementById('selectFileBtn');
        const listenBtn = document.getElementById('listenBtn');
        const audioFileInput = document.getElementById('audioFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadWordBtn = document.getElementById('downloadWordBtn');
        const transcriptBox = document.getElementById('transcript');
        const summaryBox = document.getElementById('summary');
        const transcriptStatus = document.getElementById('transcriptStatus');
        const scoreStatus = document.getElementById('scoreStatus');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const privacyBtn = document.getElementById('privacyBtn');
        const privacyPopup = document.getElementById('privacyPopup');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const agentNameInput = document.getElementById('agentNameInput');
        const customerNameInput = document.getElementById('customerNameInput');
        const audioPopup = document.getElementById('audioPopup');
        const audioPlayer = document.getElementById('audioPlayer');
        const closeAudioPopupBtn = document.getElementById('closeAudioPopupBtn');

        // ====== Helpers ======
        function toHTMLWithBreaks(text){ return (text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
        function anonymizePII(text){ if(!text) return text; let t=text; t=t.replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,'[REDACTED: email]'); t=t.replace(/\bhttps?:\/\/[^\s<)]+/gi,'[REDACTED: url]'); t=t.replace(/(?:(?:\+|00)\d{1,3}[\s.-]?)?(?:\(?\d{2,4}\)?[\s.-]?)?\d[\d\s.-]{5,}\d/g,'[REDACTED: phone]'); t=t.replace(/\b[A-Z]{2}\d{2}[A-Z0-9]{11,30}\b/gi,'[REDACTED: iban]'); t=t.replace(/(?<!\d)(?:\d[ -]?){15,19}(?!\d)/g,'[REDACTED: account]'); t=t.replace(/\bNL\d{9}B\d{2}\b/gi,'[REDACTED: vat]'); t=t.replace(/\b(username|password|wachtwoord|api\s*key|token|secret)\s*[:=]\s*\S+/gi,'[REDACTED CREDENTIAL]'); return t; }

        // ====== Theme Toggle Logic ======
        const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (currentTheme) {
            document.body.setAttribute('data-theme', currentTheme);
            darkModeToggle.textContent = currentTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        darkModeToggle.addEventListener('click', () => {
            const theme = document.body.getAttribute('data-theme');
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                darkModeToggle.textContent = 'Dark Mode';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                darkModeToggle.textContent = 'Light Mode';
            }
        });

        // ====== Initial state check and API key loading ======
        function checkApiKey(){
            OPENAI_KEY = localStorage.getItem('openai_key') || '';
            if (OPENAI_KEY) {
                apiKeyInput.value = '********'; // Mask the input
                saveKeyBtn.textContent = 'Key Saved';
                saveKeyBtn.disabled = true;
                if(audioBlob) {
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('secondary');
                    uploadBtn.classList.remove('button-blue-disabled');
                }
            } else {
                uploadBtn.disabled = true;
                uploadBtn.classList.add('secondary');
                uploadBtn.classList.remove('button-blue-disabled');
            }
        }
        window.onload = checkApiKey;
        
        saveKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if(key.startsWith('sk-')){
                localStorage.setItem('openai_key', key);
                checkApiKey();
            } else {
                alert('Please enter a valid OpenAI API key.');
            }
        });

        // ====== Diagnostics (show JS errors in UI) ======
        window.addEventListener('error', (e)=>{ summaryBox.innerHTML = '‚ùå JS error: '+(e?.message||'Unknown'); });
        window.addEventListener('unhandledrejection', (e)=>{ summaryBox.innerHTML = '‚ùå Promise error: '+(e?.reason?.message || e?.reason || 'Unknown'); });
        
        // ====== File select ======
        selectFileBtn.addEventListener('click', ()=> audioFileInput.click());
        audioFileInput.addEventListener('change', ()=>{
            const file = audioFileInput.files && audioFileInput.files[0]; if(!file) return;
            const acceptedTypes = ['audio/wav', 'audio/mpeg', 'audio/flac'];
            const isAccepted = acceptedTypes.includes(file.type) || file.name.match(/\.(wav|mp3|flac)$/i);
            if(!isAccepted){ alert('Please select a valid audio file (.wav, .mp3, .flac).'); audioFileInput.value=''; return; }
            
            audioBlob = file; 
            audioURL = URL.createObjectURL(audioBlob);
            if (OPENAI_KEY) {
                uploadBtn.disabled=false; 
                uploadBtn.classList.remove('secondary');
                uploadBtn.classList.remove('button-blue-disabled');
            }
            selectFileBtn.disabled = true;
            selectFileBtn.classList.add('button-blue-disabled');

            listenBtn.disabled = true;
            listenBtn.classList.add('secondary');
            
            transcriptStatus.textContent='File selected'; transcriptBox.textContent = `Ready: ${file.name}`;
        });
        
        // ====== Audio Playback ======
        listenBtn.addEventListener('click', () => {
            if (audioURL) {
                audioPlayer.src = audioURL;
                audioPopup.style.display = 'flex';
                audioPlayer.play();
            }
        });
        closeAudioPopupBtn.addEventListener('click', () => {
            audioPopup.style.display = 'none';
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        });

        // ====== AssemblyAI helpers ======
        async function uploadToAssemblyAI(blob){ const r=await fetch('https://api.assemblyai.com/v2/upload',{ method:'POST', headers:{ authorization: ASSEMBLY_KEY }, body: blob }); if(!r.ok) throw new Error('Upload failed: '+r.status); return (await r.json()).upload_url; }
        async function requestTranscription(audioUrl){ 
            const headers={ authorization: ASSEMBLY_KEY, 'content-type':'application/json' }; 
            const body={ 
                audio_url: audioUrl, 
                speaker_labels: true,
                speakers_expected: 2,
                language_detection: true 
            }; 
            const r=await fetch('https://api.assemblyai.com/v2/transcript',{ method:'POST', headers, body: JSON.stringify(body) }); 
            if(!r.ok) throw new Error(await r.text()); 
            const d=await r.json(); 
            return { id:d.id, headers }; 
        }
        async function pollTranscript(id, headers){ while(true){ const r=await fetch(`https://api.assemblyai.com/v2/transcript/${id}`,{ headers }); const t=await r.json(); if(t.status==='completed') return t; if(t.status==='error') throw new Error(t.error); transcriptStatus.innerHTML='Processing <span class="processing-indicator">‚è≥</span>'; transcriptBox.textContent='‚è≥ Processing...'; await new Promise(res=>setTimeout(res,3000)); } }
        function transcriptToPlain(t){ return (t.utterances && Array.isArray(t.utterances)) ? t.utterances.map(u=>`Speaker ${u.speaker}: ${u.text}`).join('\n') : (t.text||''); }

        // ====== OpenAI scoring ======
        async function analyzeWithOpenAI(transcriptText){
            if (!OPENAI_KEY) {
                throw new Error('OpenAI API key not set. Please enter your key.');
            }
            const prompt = `You are an expert service desk quality assurance analyst. Your task is to analyze the provided transcript of a customer service call and produce a structured HTML scorecard.\n\nReturn VALID HTML only (no markdown). Include, in order: \n1) <p class=\"overall-score\"><b>Overall score: X.X out of 5</b></p> (X.X is the average of five metrics rounded to one decimal).\n2) <table class=\"scorecard\"> with headers: Metric | Score (1-5) | Rationale. Use exactly these metric names: Professionalism and Script Adherence; Active Listening and Empathy; Problem-Solving and Accuracy; Sentiment and Emotional Shift; Customer Effort.\n3) <div class=\"post-summary\"> with <h4>Overall Score Explanation</h4><p>2‚Äì3 sentences.</p><h4>Recommendations</h4><ul><li>3‚Äì5 bullets</li></ul><h4>Learning Goals</h4><ul><li>3‚Äì5 bullets</li></ul>\nWrap long content so it fits within page width.\n\n**As a final step before you begin, perform a strict check for any sensitive, personally identifiable information (PII) such as names, phone numbers, email addresses, or account details. If found, replace them with a generic placeholder like [ANONYMIZED DATA] to ensure full GDPR compliance.**\n\nTRANSCRIPT (GDPR-masked):\n${anonymizePII(transcriptText)}`;
            const payload = { model: OPENAI_MODEL, messages:[{ role:'user', content: prompt }], temperature:0.2 };
            const r = await fetch('https://api.openai.com/v1/chat/completions',{ method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${OPENAI_KEY}` }, body: JSON.stringify(payload) });
            if(!r.ok) throw new Error(await r.text());
            const d=await r.json();
            
            const scorecard = d.choices?.[0]?.message?.content || '';
            
            // Calculate overall score
            let parser = new DOMParser();
            let doc = parser.parseFromString(scorecard, "text/html");
            let scores = [];
            doc.querySelectorAll('table.scorecard tr td:first-child').forEach(td => {
                let scoreText = td.textContent.trim();
                let score = parseFloat(scoreText);
                if (!isNaN(score)) {
                    scores.push(score);
                }
            });
            
            let overallScore = "N/A";
            if (scores.length > 0) {
                let sum = scores.reduce((a, b) => a + b, 0);
                overallScore = (sum / scores.length).toFixed(1);
            }
            
            let updatedScorecard = scorecard.replace(/Overall score: X\.X out of 5/, `Overall score: ${overallScore} out of 5`);
            
            return updatedScorecard;
        }

        // ====== Pipelines ======
        uploadBtn.addEventListener('click', async ()=>{
            if(!audioBlob){ alert('Please select an audio file first.'); return; }
            uploadBtn.disabled = true; 
            uploadBtn.classList.add('button-blue-disabled');
            listenBtn.disabled = true;
            listenBtn.classList.add('secondary');
            summaryBox.innerHTML=''; scoreStatus.textContent='Waiting'; 
            transcriptStatus.innerHTML='Uploading <span class="processing-indicator">‚è≥</span>'; transcriptBox.textContent='Uploading...';
            try{
                const audioUrl = await uploadToAssemblyAI(audioBlob);
                const {id, headers} = await requestTranscription(audioUrl);
                const t = await pollTranscript(id, headers);
                let plain = transcriptToPlain(t); plain = anonymizePII(plain);
                transcriptStatus.textContent='Completed'; transcriptBox.innerHTML = toHTMLWithBreaks(plain);
                scoreStatus.innerHTML='Scoring <span class="processing-indicator">‚è≥</span>'; summaryBox.innerHTML='Analyzing...';
                const scorecard = await analyzeWithOpenAI(plain);
                scoreStatus.textContent='Done'; summaryBox.innerHTML = scorecard; downloadWordBtn.disabled=false;
            }catch(err){ 
                scoreStatus.textContent='Error'; summaryBox.innerHTML='‚ùå '+(err?.message||err); downloadWordBtn.disabled=true; 
            } finally {
                uploadBtn.disabled = true;
                uploadBtn.classList.add('secondary'); 
                uploadBtn.classList.add('button-blue-disabled');
                listenBtn.disabled = false;
                listenBtn.classList.remove('secondary');
            }
        });

        clearBtn.addEventListener('click', () => {
            transcriptBox.textContent='No transcript yet...'; 
            summaryBox.innerHTML='No scorecard yet...'; 
            transcriptStatus.textContent='Idle'; 
            scoreStatus.textContent='Waiting'; 
            downloadWordBtn.disabled=true; 
            audioFileInput.value=''; 
            uploadBtn.disabled=true; 
            uploadBtn.classList.add('secondary'); /* Ensure button is gray after clearing */
            uploadBtn.classList.remove('button-blue-disabled'); 
            listenBtn.disabled = true;
            listenBtn.classList.add('secondary');
            audioBlob=null;
            selectFileBtn.disabled = false;
            selectFileBtn.classList.remove('button-blue-disabled');
            if (audioURL) {
                URL.revokeObjectURL(audioURL);
                audioURL = null;
            }
            checkApiKey(); 
        });
        
        // ====== Export to Word (Original HTML-based) ======
        function buildHtmlDoc(){ 
            const ts=new Date().toLocaleString(); 
            const scoreHtml=summaryBox.innerHTML||''; 
            const transcriptHtml=toHTMLWithBreaks((transcriptBox.innerText||'').trim()); 
            
            const agentName = agentNameInput.value.trim();
            const customerName = customerNameInput.value.trim();

            const styles = '<style>' +
                'body{font-family:Calibri,Arial,sans-serif;}' +
                'h1{font-size:22pt;color:#3D434C;}' +
                'h2{font-size:16pt;color:#3D434C;}' +
                'p{font-size:11pt;}' +
                'table{border-collapse:collapse;width:100%;font-size:11pt;}' +
                'th,td{border:1px solid #ccc;padding:6pt;vertical-align:top;}' +
                'th{background:#00B1E2;color:#fff;}' +
                '.overall-score{font-weight:bold;}' +
                '</style>';

            let callInfoHtml = '';
            if (agentName || customerName) {
                callInfoHtml += '<h2>Call Information</h2>';
                if (agentName) {
                    callInfoHtml += `<p><strong>Service Agent:</strong> ${agentName}</p>`;
                }
                if (customerName) {
                    callInfoHtml += `<p><strong>Customer Name:</strong> ${customerName}</p>`;
                }
            }

            const metricExplain='<h2 style="page-break-before: always;">Metric Explanations</h2>'+
                '<p><b>1. Professionalism and Script Adherence</b>: Politeness, professional tone, and use of required opening/closing.</p>'+
                '<p><b>2. Active Listening and Empathy</b>: Acknowledges the issue, avoids interruptions, uses empathetic phrasing.</p>'+
                '<p><b>3. Problem-Solving and Accuracy</b>: Provides correct information and a workable solution or next step.</p>'+
                '<p><b>4. Sentiment and Emotional Shift</b>: Tracks caller mood; improvement indicates effectiveness.</p>'+
                '<p><b>5. Customer Effort</b>: Minimizes repetitions/back-and-forth; efficient information gathering and resolution.</p>';
                
            return '<!DOCTYPE html><html><head><meta charset="utf-8">'+styles+'</head><body>'+
                '<h1>Service Call Scorecard</h1>' +
                '<p>Analyzed on: '+ts+'</p>'+
                callInfoHtml +
                scoreHtml+
                '<h2 style="page-break-before: always;">Transcript</h2><p>'+
                transcriptHtml.replace(/<br>/g,'</p><p>')+
                '</p>'+
                metricExplain+'</body></html>'; 
        }

        downloadWordBtn.addEventListener('click', ()=>{
            if(!summaryBox.innerHTML || summaryBox.innerHTML.includes('No scorecard')){ alert('No scorecard to download yet.'); return; }
            
            const html = buildHtmlDoc();
            const blob = new Blob([html], { type: 'application/msword' }); 
            const url = URL.createObjectURL(blob); 
            const a=document.createElement('a'); 
            a.href=url; 
            a.download=`ServiceCall_Scorecard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.doc`; 
            document.body.appendChild(a); 
            a.click(); 
            a.remove(); 
            URL.revokeObjectURL(url);
        });
        
        // ====== New Event Listeners for Privacy Popup ======
        privacyBtn.addEventListener('click', () => {
            privacyPopup.style.display = 'flex';
        });

        closePopupBtn.addEventListener('click', () => {
            privacyPopup.style.display = 'none';
        });

        privacyPopup.addEventListener('click', (event) => {
            if (event.target === privacyPopup) {
                privacyPopup.style.display = 'none';
            }
        });
    </script>
</body>
</html>
