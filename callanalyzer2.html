<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Call Analyzer</title>
  <style>
    :root { --just-grey:#3D434C; --light-blue:#00B1E2; --medium-grey:#666; --body-text:#434343; --surface:#fff; --surface-alt:#F7F8FA; --radius:14px; --gap:12px; --shadow:0 4px 14px rgba(0,0,0,.06); }
    body{font-family: Calibri, "Century Gothic", Arial, sans-serif; color:var(--body-text); margin:0; background:var(--surface-alt);} 
    .wrap{max-width:980px; margin:0 auto; padding:clamp(12px,3vw,28px);} 
    h1{font-weight:700; font-size:clamp(28px,5.5vw,47px); color:var(--just-grey); margin:8px 0 4px; display:flex; align-items:center; gap:10px;} 
    h1 .badge{color:var(--light-blue);} 
    .subtitle{font-style:italic; color:var(--medium-grey); font-size:clamp(14px,2.5vw,22px); margin:0 0 16px;} 
    h3{font-weight:700; font-size:clamp(16px,3vw,24px); color:var(--light-blue); margin:0 0 8px;}
    .card{background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); padding:clamp(12px,3vw,18px); border:1px solid #EAECEF;}
    .controls{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:var(--gap); position:sticky; top:0; background:var(--surface-alt); padding:10px 0; z-index:5; align-items:stretch;}
    .api-key-controls{display:grid; grid-template-columns:1fr auto; gap:var(--gap); align-items:center; margin-bottom:12px;}
    .api-key-controls input[type="password"]{width:100%; padding:14px 16px; border:1px solid #ccc; border-radius:12px; box-sizing:border-box;}
    .api-key-controls button{min-width:120px; padding:14px;}
    button{width:100%; border:none; border-radius:12px; padding:14px 16px; font-weight:700; font-size:16px; background:var(--light-blue); color:#fff; box-shadow:var(--shadow); cursor:pointer; box-sizing:border-box; min-height:48px;}
    button.secondary{background:var(--just-grey);} 
    button:disabled{opacity:.55; box-shadow:none; cursor:not-allowed;}
    .panel{margin-top:14px; display:grid; gap:var(--gap);} 
    .pre{background:#fff; border:1px solid #E6E8EB; border-radius:var(--radius); padding:clamp(12px,3vw,18px); min-height:140px; font-size:16px; line-height:1.45; color:var(--body-text); max-width:100%; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; overflow-x:hidden; box-sizing:border-box;} 
    textarea.input-area{display:block; max-width:100%; width:100%; min-height:140px; border:1px solid #ccc; border-radius:var(--radius); padding:12px; font-size:16px; font-family: Calibri, "Century Gothic", Arial, sans-serif; resize:vertical; box-sizing:border-box;}
    table.scorecard{width:100%; border-collapse:collapse; font-size:15px; table-layout:fixed;} 
    table.scorecard th, table.scorecard td{border:1px solid #E6E8EB; padding:8px; vertical-align:top; word-break:break-word;}
    table.scorecard th{background:var(--light-blue); color:#fff; font-weight:700; text-align:left;} 
    table.scorecard tr:nth-child(even){background:#F9FAFB;} 
    .overall-score{font-weight:700; color:var(--just-grey); margin:8px 0 6px;} 
    .post-summary{margin-top:8px;} 
    .post-summary h4{margin:8px 0 4px; font-size:18px; color:var(--just-grey); font-weight:700;} 
    .post-summary p{margin:0 0 6px;} 
    .post-summary ul{margin:0 0 0 18px; padding:0;} 
    .post-summary li{margin:0; padding:0;} 
    .actions-row{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;} 
    .status{display:inline-block; padding:4px 10px; border-radius:999px; background:#E8F8FE; color:var(--light-blue); font-weight:700; font-size:13px;} 
    footer{margin-top:30px; font-size:13px; color:var(--medium-grey); text-align:center;}
    
    /* New styles for the privacy popup */
    #privacyPopup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }
    
    #privacyPopup .content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    #privacyPopup h2 {
      margin-top: 0;
    }

    #privacyPopup button#closePopupBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: auto;
      min-width: 0;
      padding: 5px 10px;
      background: var(--just-grey);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="badge">📞</span> Service Call Analyzer</h1>
    <p class="subtitle">Record a service call, upload a WAV file, or paste a transcript manually — then let ChatGPT generate a scored <strong>Service Call Scorecard</strong>.</p>

    <div class="card">
      <h3>Enter your OpenAI API Key</h3>
      <p>Your key is stored only in your browser's local storage.</p>
      <div class="api-key-controls">
        <input type="password" id="apiKeyInput" placeholder="sk-..." />
        <button id="saveKeyBtn">Save Key</button>
      </div>
    </div>
    
    <div class="controls">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
      <button id="selectFileBtn">Select WAV File</button>
      <button id="uploadBtn" disabled>Upload & Analyze</button>
      <button id="analyzeManualBtn">Analyze Manual Transcript</button>
      <button id="clearBtn" class="secondary">Clear Output</button>
      <button id="privacyBtn" class="secondary">Privacy Statement</button>
      <button id="callGeneratorBtn" class="secondary">AI Call Generator</button>
      <input id="audioFile" type="file" accept="audio/wav,.wav" style="display:none" />
    </div>

    <div class="panel">
      <div class="card">
        <h3>Transcript <span id="transcriptStatus" class="status">Idle</span></h3>
        <textarea id="manualTranscript" class="input-area" placeholder="Paste or type transcript here..."></textarea>
        <pre id="transcript" class="pre">No transcript yet...</pre>
      </div>

      <div class="card">
        <h3>Service Call Scorecard <span id="scoreStatus" class="status">Waiting</span></h3>
        <div id="summary" class="pre">No scorecard yet...</div>
        <div class="actions-row">
          <button id="downloadWordBtn" class="secondary" disabled>Download as Word</button>
        </div>
      </div>
    </div>

    <footer>
      All call transcripts and scorecards are automatically anonymized in accordance with GDPR standards and regulations.
    </footer>
  </div>

  <div id="privacyPopup">
      <div class="content">
          <h2 style="margin-top:0;">Privacy Statement</h2>
          <p>Your privacy is our priority. This website is designed to analyze service calls without collecting or storing any of your personal data. We want you to feel confident knowing how your information is handled.</p>
          <h4>How It Works: Privacy by Design</h4>
          <p>The "Service Call Analyzer" is a "frontend" web application. This means it runs entirely in your web browser. We do not have a separate server to process or store your data.</p>
          <ul>
              <li>**No Data Storage:** We do not save your audio recordings, uploaded files, or transcripts on our servers. Your information exists only temporarily in your browser's memory while the analysis is taking place.</li>
              <li>**Direct-to-API Communication:** Your data is sent directly from your browser to trusted third-party services for processing. We use <b>AssemblyAI</b> for transcription and <b>OpenAI</b> for generating the scorecard.</li>
              <li>**Data Minimization:** We only send the information that is necessary for the task at hand.</li>
          </ul>
          <h4>Our Privacy Safeguards</h4>
          <p>We've implemented a multi-layered approach to protect your data and comply with privacy regulations like the GDPR.</p>
          <ol>
              <li>**Client-Side Anonymization:** Before any transcript is sent to a third-party API, a special function in the application automatically checks for sensitive information like names, phone numbers, email addresses, and account details. It replaces this data with a generic placeholder like <code>[ANONYMIZED DATA]</code> to ensure no personally identifiable information (PII) leaves your browser in its original form.</li>
              <li>**Explicit AI Instructions:** We specifically instruct the AI model to perform an additional, strict check for any remaining PII and to replace it with a placeholder to ensure compliance.</li>
              <li>**Third-Party Agreements:** We have formal agreements, known as Data Processing Addendums (DPAs), with our service providers (AssemblyAI and OpenAI). These contracts legally bind them to handle your data securely and in accordance with privacy laws.</li>
              <li>**Your Responsibility:** Once you download the generated scorecard and transcript as a Word document, you are responsible for how you store and handle that file.</li>
          </ol>
          <p>For any questions about our privacy practices, please contact us.</p>
          <button id="closePopupBtn">Close</button>
      </div>
  </div>

  <script>
    // ====== CONFIG (keys you provided) ======
    const ASSEMBLY_KEY = "99bfc1680f0b4cca9e7d3ce2495eb058";
    const OPENAI_MODEL = "gpt-4o-mini";
    
    let OPENAI_KEY = '';

    // ====== Helpers ======
    function toHTMLWithBreaks(text){ return (text||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
    function anonymizePII(text){ if(!text) return text; let t=text; t=t.replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,'[REDACTED: email]'); t=t.replace(/\bhttps?:\/\/[^\s<)]+/gi,'[REDACTED: url]'); t=t.replace(/(?:(?:\+|00)\d{1,3}[\s.-]?)?(?:\(?\d{2,4}\)?[\s.-]?)?\d[\d\s.-]{5,}\d/g,'[REDACTED: phone]'); t=t.replace(/\b[A-Z]{2}\d{2}[A-Z0-9]{11,30}\b/gi,'[REDACTED: iban]'); t=t.replace(/(?<!\d)(?:\d[ -]?){15,19}(?!\d)/g,'[REDACTED: account]'); t=t.replace(/\bNL\d{9}B\d{2}\b/gi,'[REDACTED: vat]'); t=t.replace(/\b(username|password|wachtwoord|api\s*key|token|secret)\s*[:=]\s*\S+/gi,'[REDACTED CREDENTIAL]'); return t; }

    // ====== Elements ======
    const startBtn=document.getElementById('startBtn');
    const stopBtn=document.getElementById('stopBtn');
    const selectFileBtn=document.getElementById('selectFileBtn');
    const audioFileInput=document.getElementById('audioFile');
    const uploadBtn=document.getElementById('uploadBtn');
    const analyzeManualBtn=document.getElementById('analyzeManualBtn');
    const clearBtn=document.getElementById('clearBtn');
    const downloadWordBtn=document.getElementById('downloadWordBtn');
    const manualTranscriptEl=document.getElementById('manualTranscript');
    const transcriptBox=document.getElementById('transcript');
    const summaryBox=document.getElementById('summary');
    const transcriptStatus=document.getElementById('transcriptStatus');
    const scoreStatus=document.getElementById('scoreStatus');
    const apiKeyInput=document.getElementById('apiKeyInput');
    const saveKeyBtn=document.getElementById('saveKeyBtn');
    const privacyBtn = document.getElementById('privacyBtn');
    const privacyPopup = document.getElementById('privacyPopup');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const callGeneratorBtn = document.getElementById('callGeneratorBtn');

    // ====== Initial state check and API key loading ======
    function checkApiKey(){
      OPENAI_KEY = localStorage.getItem('openai_key') || '';
      if (OPENAI_KEY) {
        apiKeyInput.value = '********'; // Mask the input
        saveKeyBtn.textContent = 'Key Saved';
        saveKeyBtn.disabled = true;
        uploadBtn.disabled = false;
        analyzeManualBtn.disabled = false;
        console.log('API Key loaded from local storage.');
      } else {
        uploadBtn.disabled = true;
        analyzeManualBtn.disabled = true;
        console.log('No API Key found. Please enter one.');
      }
    }
    window.onload = checkApiKey;
    
    saveKeyBtn.addEventListener('click', () => {
      const key = apiKeyInput.value.trim();
      if(key.startsWith('sk-')){
        localStorage.setItem('openai_key', key);
        checkApiKey();
      } else {
        alert('Please enter a valid OpenAI API key.');
      }
    });

    // ====== Diagnostics (show JS errors in UI) ======
    window.addEventListener('error', (e)=>{ summaryBox.innerHTML = '❌ JS error: '+(e?.message||'Unknown'); });
    window.addEventListener('unhandledrejection', (e)=>{ summaryBox.innerHTML = '❌ Promise error: '+(e?.reason?.message || e?.reason || 'Unknown'); });

    // ====== Recording ======
    let mediaRecorder; let audioChunks=[]; let audioBlob=null;
    startBtn.addEventListener('click', async ()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e=> audioChunks.push(e.data);
        mediaRecorder.onstop = ()=>{ audioBlob = new Blob(audioChunks,{ type:'audio/webm' }); uploadBtn.disabled=false; };
        mediaRecorder.start();
        startBtn.disabled=true; stopBtn.disabled=false;
        transcriptStatus.textContent='Recording'; transcriptBox.textContent='🎙️ Recording...';
      }catch(e){ alert('Microphone error: '+e.message); }
    });
    stopBtn.addEventListener('click', ()=>{
      if(mediaRecorder && mediaRecorder.state!=='inactive'){
        mediaRecorder.stop(); startBtn.disabled=false; stopBtn.disabled=true;
        transcriptStatus.textContent='Ready'; transcriptBox.textContent='Recording stopped. Ready to upload.';
      }
    });

    // ====== File select (WAV) ======
    selectFileBtn.addEventListener('click', ()=> audioFileInput.click());
    audioFileInput.addEventListener('change', ()=>{
      const file = audioFileInput.files && audioFileInput.files[0]; if(!file) return;
      const isWav = file.type==='audio/wav' || file.name.toLowerCase().endsWith('.wav');
      if(!isWav){ alert('Please select a valid WAV file (.wav).'); audioFileInput.value=''; return; }
      audioBlob = file; uploadBtn.disabled=false; startBtn.disabled=true; stopBtn.disabled=true;
      transcriptStatus.textContent='File selected'; transcriptBox.textContent = `Ready: ${file.name}`;
    });

    // ====== AssemblyAI helpers ======
    async function uploadToAssemblyAI(blob){ const r=await fetch('https://api.assemblyai.com/v2/upload',{ method:'POST', headers:{ authorization: ASSEMBLY_KEY }, body: blob }); if(!r.ok) throw new Error('Upload failed: '+r.status); return (await r.json()).upload_url; }
    async function requestTranscription(audioUrl){ const headers={ authorization: ASSEMBLY_KEY, 'content-type':'application/json' }; const body={ audio_url: audioUrl, speaker_labels: true, language_detection: true }; const r=await fetch('https://api.assemblyai.com/v2/transcript',{ method:'POST', headers, body: JSON.stringify(body) }); if(!r.ok) throw new Error(await r.text()); const d=await r.json(); return { id:d.id, headers }; }
    async function pollTranscript(id, headers){ while(true){ const r=await fetch(`https://api.assemblyai.com/v2/transcript/${id}`,{ headers }); const t=await r.json(); if(t.status==='completed') return t; if(t.status==='error') throw new Error(t.error); transcriptStatus.textContent='Processing'; transcriptBox.textContent='⏳ Processing...'; await new Promise(res=>setTimeout(res,3000)); } }
    function transcriptToPlain(t){ return (t.utterances && Array.isArray(t.utterances)) ? t.utterances.map(u=>`Speaker ${u.speaker}: ${u.text}`).join('\n') : (t.text||''); }

    // ====== OpenAI scoring ======
async function analyzeWithOpenAI(transcriptText){
  if (!OPENAI_KEY) {
    throw new Error('OpenAI API key not set. Please enter your key.');
  }
  const prompt = `You are an expert service desk quality assurance analyst. Your task is to analyze the provided transcript of a customer service call and produce a structured HTML scorecard.\n\nReturn VALID HTML only (no markdown). Include, in order: \n1) <p class=\"overall-score\"><b>Overall score: X.X out of 5</b></p> (X.X is the average of five metrics rounded to one decimal).\n2) <table class=\"scorecard\"> with headers: Metric | Score (1-5) | Rationale. Use exactly these metric names: Professionalism and Script Adherence; Active Listening and Empathy; Problem-Solving and Accuracy; Sentiment and Emotional Shift; Customer Effort.\n3) <div class=\"post-summary\"> with <h4>Overall Score Explanation</h4><p>2–3 sentences.</p><h4>Recommendations</h4><ul><li>3–5 bullets</li></ul><h4>Learning Goals</h4><ul><li>3–5 bullets</li></ul>\nWrap long content so it fits within page width.\n\n**As a final step before you begin, perform a strict check for any sensitive, personally identifiable information (PII) such as names, phone numbers, email addresses, or account details. If found, replace them with a generic placeholder like [ANONYMIZED DATA] to ensure full GDPR compliance.**\n\nTRANSCRIPT (GDPR-masked):\n${anonymizePII(transcriptText)}`;
  const payload = { model: OPENAI_MODEL, messages:[{ role:'user', content: prompt }], temperature:0.2 };
  const r = await fetch('https://api.openai.com/v1/chat/completions',{ method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${OPENAI_KEY}` }, body: JSON.stringify(payload) });
  if(!r.ok) throw new Error(await r.text());
  const d=await r.json();
  return d.choices?.[0]?.message?.content || '';
}

    // ====== Pipelines ======
    uploadBtn.addEventListener('click', async ()=>{
      if(!audioBlob){ alert('Please record audio or select a WAV file first.'); return; }
      summaryBox.innerHTML=''; scoreStatus.textContent='Waiting'; transcriptStatus.textContent='Uploading'; transcriptBox.textContent='Uploading...';
      try{
        const audioUrl = await uploadToAssemblyAI(audioBlob);
        const {id, headers} = await requestTranscription(audioUrl);
        const t = await pollTranscript(id, headers);
        let plain = transcriptToPlain(t); plain = anonymizePII(plain);
        transcriptStatus.textContent='Completed'; transcriptBox.innerHTML = toHTMLWithBreaks(plain);
        scoreStatus.textContent='Scoring'; summaryBox.innerHTML='Analyzing...';
        const scorecard = await analyzeWithOpenAI(plain);
        scoreStatus.textContent='Done'; summaryBox.innerHTML = scorecard; downloadWordBtn.disabled=false;
      }catch(err){ scoreStatus.textContent='Error'; summaryBox.innerHTML='❌ '+(err?.message||err); downloadWordBtn.disabled=true; }
    });

    analyzeManualBtn.addEventListener('click', async ()=>{
      let manualText = (manualTranscriptEl.value||'').trim(); if(!manualText){ alert('Please paste or type a transcript first.'); return; }
      manualText = anonymizePII(manualText);
      transcriptBox.innerHTML = toHTMLWithBreaks(manualText); transcriptStatus.textContent='Manual'; scoreStatus.textContent='Scoring'; summaryBox.innerHTML='Analyzing...';
      try{ const scorecard = await analyzeWithOpenAI(manualText); scoreStatus.textContent='Done'; summaryBox.innerHTML=scorecard; downloadWordBtn.disabled=false; }catch(err){ scoreStatus.textContent='Error'; summaryBox.innerHTML='❌ '+(err?.message||err); downloadWordBtn.disabled=true; }
    });

    clearBtn.addEventListener('click', () => {
      manualTranscriptEl.value=''; 
      transcriptBox.textContent='No transcript yet...'; 
      summaryBox.innerHTML='No scorecard yet...'; 
      transcriptStatus.textContent='Idle'; 
      scoreStatus.textContent='Waiting'; 
      downloadWordBtn.disabled=true; 
      audioFileInput.value=''; 
      startBtn.disabled=false; 
      stopBtn.disabled=true; 
      uploadBtn.disabled=true; 
      audioBlob=null;
      checkApiKey(); // Re-check the key state to re-enable buttons
    });

    // ====== Export to Word (DOCX, with HTML fallback) ======
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.defer=true; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
    async function ensureDocx(){ if(window.docx) return true; try{ await loadScript('https://cdn.jsdelivr.net/npm/docx@8.1.0/build/index.umd.js'); }catch(e){} return !!window.docx; }
    function buildHtmlDoc(){ const ts=new Date().toLocaleString(); const scoreHtml=summaryBox.innerHTML||''; const transcriptHtml=toHTMLWithBreaks((transcriptBox.innerText||'').trim()); const styles='<style>body{font-family:Calibri,Arial,sans-serif}h1{font-size:22pt;color:#3D434C}h2{font-size:16pt;color:#3D434C}p{font-size:11pt}table{border-collapse:collapse;width:100%;font-size:11pt}th,td{border:1px solid #ccc;padding:6pt;vertical-align:top}th{background:#00B1E2;color:#fff}.overall-score{font-weight:bold}</style>'; const metricExplain='<h2 style="page-break-before: always;">Metric Explanations</h2>'+'<p><b>1. Professionalism and Script Adherence</b>: Politeness, professional tone, and use of required opening/closing.</p>'+'<p><b>2. Active Listening and Empathy</b>: Acknowledges the issue, avoids interruptions, uses empathetic phrasing.</p>'+'<p><b>3. Problem-Solving and Accuracy</b>: Provides correct information and a workable solution or next step.</p>'+'<p><b>4. Sentiment and Emotional Shift</b>: Tracks caller mood; improvement indicates effectiveness.</p>'+'<p><b>5. Customer Effort</b>: Minimizes repetitions/back-and-forth; efficient information gathering and resolution.</p>'; return '<!DOCTYPE html><html><head><meta charset="utf-8">'+styles+'</head><body>'+'<h1>Service Call Scorecard</h1><p>Analyzed on: '+ts+'</p>'+scoreHtml+'<h2 style="page-break-before: always;">Transcript</h2><p>'+transcriptHtml.replace(/<br>/g,'</p><p>')+'</p>'+metricExplain+'</body></html>'; }

    downloadWordBtn.addEventListener('click', async ()=>{
      if(!summaryBox.innerHTML || summaryBox.innerHTML.includes('No scorecard')){ alert('No scorecard to download yet.'); return; }
      const hasDocx = await ensureDocx();
      if(hasDocx){ const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel } = window.docx; const getText = el => (el ? el.textContent.trim() : ''); const ts = new Date().toLocaleString(); const overallText = getText(summaryBox.querySelector('.overall-score')) || 'Overall score: N/A'; const tableEl = summaryBox.querySelector('table.scorecard'); let table; if(tableEl){ const rows=[]; tableEl.querySelectorAll('tr').forEach(tr=>{ const cells = Array.from(tr.children).map(td=> new TableCell({ children:[ new Paragraph(td.textContent.trim()) ] })); rows.push(new TableRow({ children: cells })); }); table = new Table({ rows, width:{ size:100, type: WidthType.PERCENTAGE } }); } const post = summaryBox.querySelector('.post-summary'); const page1Children=[]; if(post){ post.childNodes.forEach(node=>{ if(node.nodeType!==1) return; const tag=node.tagName.toLowerCase(); const txt=(node.textContent||'').trim(); if(!txt) return; if(tag==='h4') page1Children.push(new Paragraph({ text: txt, heading: HeadingLevel.HEADING_3 })); if(tag==='p') page1Children.push(new Paragraph({ text: txt })); if(tag==='ul') node.querySelectorAll('li').forEach(li=> page1Children.push(new Paragraph({ text: (li.textContent||'').trim(), bullet:{ level:0 } }))); }); } const transcriptPlain=(transcriptBox.innerText||'').trim(); const transcriptParas = transcriptPlain.split(/\n+/).map(line=> new Paragraph(line)); const metricExplanation=[ new Paragraph({ text:'Metric Explanations', heading: HeadingLevel.HEADING_2, pageBreakBefore:true }), new Paragraph({ text:'1. Professionalism and Script Adherence: Politeness, use of required opening/closing, professional tone.' }), new Paragraph({ text:'2. Active Listening and Empathy: Acknowledges the issue, avoids interruptions, uses empathetic phrasing.' }), new Paragraph({ text:'3. Problem-Solving and Accuracy: Provides correct information and a workable solution or clear next step.' }), new Paragraph({ text:'4. Sentiment and Emotional Shift: Tracks caller mood; improvement after assistance indicates effectiveness.' }), new Paragraph({ text:'5. Customer Effort: Minimizes repetitions and back-and-forth; efficient information gathering and resolution.' }), ]; const doc = new Document({ sections:[{ properties:{}, children:[ new Paragraph({ text:'Service Call Scorecard', heading: HeadingLevel.HEADING_1 }), new Paragraph({ text:`Analyzed on: ${ts}` }), new Paragraph({ text: overallText }), ...(table?[table]:[]), ...page1Children, new Paragraph({ text:'Transcript', heading: HeadingLevel.HEADING_2, pageBreakBefore:true }), ...transcriptParas, ...metricExplanation ] }] }); const blob = await Packer.toBlob(doc); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ServiceCall_Scorecard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.docx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); return; }
      const html = buildHtmlDoc(); const blob = new Blob([html], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ServiceCall_Scorecard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.doc`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    
    // ====== New Event Listeners for Privacy Popup ======
    privacyBtn.addEventListener('click', () => {
        privacyPopup.style.display = 'flex';
    });

    closePopupBtn.addEventListener('click', () => {
        privacyPopup.style.display = 'none';
    });

    privacyPopup.addEventListener('click', (event) => {
        if (event.target === privacyPopup) {
            privacyPopup.style.display = 'none';
        }
    });

    // ====== New Event Listener for AI Call Generator Button ======
    callGeneratorBtn.addEventListener('click', () => {
        window.open('Callgenerator.html', '_blank');
    });
  </script>
</body>
</html>